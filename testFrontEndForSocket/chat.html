<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KashefChat - Chat Room</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; height: 90vh; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        
        /* The main chat area displaying messages */
        #chat-box { 
            flex-grow: 1; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            padding: 15px; 
            overflow-y: auto; 
            background-color: #f9f9f9; 
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Message Styles */
        .message { 
            padding: 8px 12px; 
            border-radius: 15px; 
            max-width: 70%; 
            word-wrap: break-word; 
            position: relative;
            cursor: pointer;
        }
        .message.sent { align-self: flex-end; background-color: #007bff; color: white; }
        .message.received { align-self: flex-start; background-color: #e9ecef; color: black; }
        .sender-name { font-size: 0.75em; margin-bottom: 2px; opacity: 0.8; font-weight: bold; }
        .message-time { 
            font-size: 0.65em; 
            margin-top: 4px; 
            opacity: 0.7; 
            text-align: right; 
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }
        .read-status {
            font-size: 1em;
            display: inline-block;
        }
        .read-status.read { color: #4CAF50; }
        .read-status.unread { opacity: 0.5; }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            min-width: 120px;
        }
        .context-menu.show { display: block; }
        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .context-menu-item:hover { background-color: #f0f0f0; }
        .context-menu-item:first-child { border-radius: 5px 5px 0 0; }
        .context-menu-item:last-child { border-radius: 0 0 5px 5px; }
        .context-menu-item.disabled { opacity: 0.5; cursor: not-allowed; }

        /* Input Area Styles */
        .input-area { display: flex; gap: 10px; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #send-btn { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

    <header>
        <!-- Shows who you are chatting with -->
        <h2 id="chat-header">Chatting in room: <span id="friend-name">Loading...</span></h2>
        <button onclick="window.location.href='friends.html'">Back to Friends</button>
    </header>

    <!-- ============================== -->
    <!-- CHAT HISTORY SECTION           -->
    <!-- ============================== -->
    <!-- This div will contain all the message bubbles -->
    <div id="chat-box">
        <p style="text-align: center; color: #999;">Loading messages...</p>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item disabled" data-action="edit">Edit</div>
        <div class="context-menu-item" data-action="delete">Delete</div>
    </div>

    <!-- ============================== -->
    <!-- MESSAGING AREA                 -->
    <!-- ============================== -->
    <div class="input-area">
        <!-- Input field for typing new messages -->
        <input type="text" id="message-input" placeholder="Type your message here...">
        <!-- Button to send the message -->
        <button id="send-btn">Send</button>
    </div>

    <script>
        // ==========================================
        // SCRIPT SECTION
        // ==========================================
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chatId');
        
        let currentUserId = null;
        let currentUserName = null;
        let selectedMessageId = null;

        const socket = io('http://127.0.0.1:3000', { withCredentials: true });

        const sendBtn = document.getElementById('send-btn');
        const messageInput = document.getElementById('message-input');
        const chatBox = document.getElementById('chat-box');
        const contextMenu = document.getElementById('context-menu');

        // Format time to 12-hour format
        function formatTime(dateString) {
            const date = new Date(dateString);
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            return `${hours}:${minutes} ${ampm}`;
        }

        // Load chat data on page load
        window.addEventListener('load', async () => {
            try {
                // Get current user info
                const userResponse = await fetch("http://127.0.0.1:3000/api/v1/user/me", {
                    method: "GET",
                    credentials: "include"
                });
                
                // Check if user is authenticated
                if (!userResponse.ok) {
                    console.error('Please login first');
                    window.location.href = 'index.html';
                    return;
                }
                
                const userData = await userResponse.json();
                currentUserId = userData.data.user.id;
                currentUserName = userData.data.user.name;
                // Get chat details and messages
                const chatResponse = await fetch(`http://127.0.0.1:3000/api/v1/chat/${chatId}`, {
                    method: "GET",
                    credentials: "include"
                });

                if (!chatResponse.ok) {
                    throw new Error('Failed to load chat');
                }

                const chatData = await chatResponse.json();
                const chat = chatData.data.chat;

                // Find the other user (friend)
                const friend = chat.members.find(member => member.userId !== currentUserId);
                if (friend) {
                    document.getElementById('friend-name').textContent = friend.user.name;
                }

                // Join the chat room
                socket.emit('joinChat', { chatId });

                // Load existing messages
                chatBox.innerHTML = '';
                if (chat.messages && chat.messages.length > 0) {
                    // Messages are in descending order, reverse them
                    chat.messages.reverse().forEach(message => {
                        const isSent = message.senderId === currentUserId;
                        const senderName = isSent ? 'You' : friend.user.name;
                        appendMessage(message.id, message.content, isSent ? 'sent' : 'received', senderName, message.sentAt, isSent);
                        
                        // Mark received messages as read
                        if (!isSent && !message.isRead) {
                            socket.emit('markMessageAsRead', { messageId: message.id, chatId: chatId });
                        }
                    });
                } else {
                    chatBox.innerHTML = '<p style="text-align: center; color: #999;">No messages yet. Start the conversation!</p>';
                }

            } catch (error) {
                console.error('Error loading chat:', error);
                console.error('Failed to load chat. Please login first.');
                window.location.href = 'index.html';
            }
        });

        // Send message function
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            socket.emit('sendMessage', { 
                chatId: chatId, 
                content: text,
                senderId: currentUserId,
                senderName: currentUserName
            });

            messageInput.value = ''; // Clear input
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Function to add message to UI
        function appendMessage(messageId, text, type, sender, timestamp, canDelete = false) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', type);
            msgDiv.dataset.messageId = messageId;
            
            const nameDiv = document.createElement('div');
            nameDiv.classList.add('sender-name');
            nameDiv.innerText = sender;

            const contentDiv = document.createElement('div');
            contentDiv.innerText = text;

            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            timeDiv.innerText = formatTime(timestamp);

            msgDiv.appendChild(nameDiv);
            msgDiv.appendChild(contentDiv);
            msgDiv.appendChild(timeDiv);

            // Add context menu only for sent messages
            if (canDelete) {
                msgDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    selectedMessageId = messageId;
                    showContextMenu(e.pageX, e.pageY);
                });
            }

            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto scroll to bottom
        }

        // Show context menu
        function showContextMenu(x, y) {
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.classList.add('show');
        }

        // Hide context menu
        function hideContextMenu() {
            contextMenu.classList.remove('show');
            selectedMessageId = null;
        }

        // Hide context menu on click outside
        document.addEventListener('click', hideContextMenu);

        // Context menu actions
        contextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            
            if (action === 'delete' && selectedMessageId) {
                deleteMessage(selectedMessageId);
            } else if (action === 'edit') {
                // Edit functionality will be implemented later
                console.log('Edit feature coming soon!');
            }
            
            hideContextMenu();
        });

        // Delete message function
        function deleteMessage(messageId) {
            socket.emit('deleteMessage', { 
                messageId: messageId,
                chatId: chatId
            });
        }

        // Listener for incoming messages
        socket.on('receiveMessage', (message) => {
            const isSent = message.senderId === currentUserId;
            const senderName = isSent ? 'You' : message.senderName;
            appendMessage(message.id, message.content, isSent ? 'sent' : 'received', senderName, message.sentAt, isSent);
            
            // If received message, mark as read
            if (!isSent) {
                socket.emit('markMessageAsRead', { messageId: message.id, chatId: chatId });
            }
        });

        // Listener for deleted messages
        socket.on('messageDeleted', (data) => {
            const messageElement = document.querySelector(`[data-message-id="${data.id}"]`);
            if (messageElement) {
                messageElement.remove();
            }
        });

        // Listener for message read status
        socket.on('messageRead', (data) => {
            const readIcon = document.querySelector(`.read-status[data-message-id="${data.id}"]`);
            if (readIcon) {
                readIcon.classList.remove('unread');
                readIcon.classList.add('read');
            }
        });
    </script>
</body>
</html>