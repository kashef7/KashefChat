<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KashefChat - Chat Room</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; height: 90vh; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        
        /* The main chat area displaying messages */
        #chat-box { 
            flex-grow: 1; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            padding: 15px; 
            overflow-y: auto; 
            background-color: #f9f9f9; 
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Message Styles */
        .message { padding: 8px 12px; border-radius: 15px; max-width: 70%; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background-color: #007bff; color: white; }
        .message.received { align-self: flex-start; background-color: #e9ecef; color: black; }
        .sender-name { font-size: 0.75em; margin-bottom: 2px; opacity: 0.8; }

        /* Input Area Styles */
        .input-area { display: flex; gap: 10px; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #send-btn { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

    <header>
        <!-- Shows who you are chatting with -->
        <h2 id="chat-header">Chatting in room: <span id="friend-name">Loading...</span></h2>
        <button onclick="window.location.href='friends.html'">Back to Friends</button>
    </header>

    <!-- ============================== -->
    <!-- CHAT HISTORY SECTION           -->
    <!-- ============================== -->
    <!-- This div will contain all the message bubbles -->
    <div id="chat-box">
        <p style="text-align: center; color: #999;">Loading messages...</p>
    </div>

    <!-- ============================== -->
    <!-- MESSAGING AREA                 -->
    <!-- ============================== -->
    <div class="input-area">
        <!-- Input field for typing new messages -->
        <input type="text" id="message-input" placeholder="Type your message here...">
        <!-- Button to send the message -->
        <button id="send-btn">Send</button>
    </div>

    <script>
        // ==========================================
        // SCRIPT SECTION
        // ==========================================
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chatId');
        
        let currentUserId = null;
        let currentUserName = null;

        const socket = io('http://localhost:3000', {});

        const sendBtn = document.getElementById('send-btn');
        const messageInput = document.getElementById('message-input');
        const chatBox = document.getElementById('chat-box');

        // Load chat data on page load
        window.addEventListener('load', async () => {
            try {
                // Get current user info
                const userResponse = await fetch("http://127.0.0.1:3000/api/v1/user/me", {
                    method: "GET",
                    credentials: "include"
                });
                
                // Check if user is authenticated
                if (!userResponse.ok) {
                    alert('Please login first');
                    window.location.href = 'index.html';
                    return;
                }
                
                const userData = await userResponse.json();
                currentUserId = userData.data.user.id;
                currentUserName = userData.data.user.name;
                // Get chat details and messages
                const chatResponse = await fetch(`http://127.0.0.1:3000/api/v1/chat/${chatId}`, {
                    method: "GET",
                    credentials: "include"
                });

                if (!chatResponse.ok) {
                    throw new Error('Failed to load chat');
                }

                const chatData = await chatResponse.json();
                const chat = chatData.data.chat;

                // Find the other user (friend)
                const friend = chat.members.find(member => member.userId !== currentUserId);
                if (friend) {
                    document.getElementById('friend-name').textContent = friend.user.name;
                }

                // Join the chat room
                socket.emit('joinChat', { chatId });

                // Load existing messages
                chatBox.innerHTML = '';
                if (chat.messages && chat.messages.length > 0) {
                    // Messages are in descending order, reverse them
                    chat.messages.reverse().forEach(message => {
                        const isSent = message.senderId === currentUserId;
                        const senderName = isSent ? 'You' : friend.user.name;
                        appendMessage(message.content, isSent ? 'sent' : 'received', senderName);
                    });
                } else {
                    chatBox.innerHTML = '<p style="text-align: center; color: #999;">No messages yet. Start the conversation!</p>';
                }

            } catch (error) {
                console.error('Error loading chat:', error);
                alert('Failed to load chat. Please login first.');
                window.location.href = 'index.html';
            }
        });

        // Send message function
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            socket.emit('sendMessage', { 
                chatId: chatId, 
                content: text,
                senderId: currentUserId,
                senderName: currentUserName
            });

            messageInput.value = ''; // Clear input
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Function to add message to UI
        function appendMessage(text, type, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', type);
            
            const nameDiv = document.createElement('div');
            nameDiv.classList.add('sender-name');
            nameDiv.innerText = sender;

            msgDiv.appendChild(nameDiv);
            msgDiv.appendChild(document.createTextNode(text));

            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto scroll to bottom
        }

        // Listener for incoming messages
        socket.on('receiveMessage', (message) => {
            const isSent = message.senderId === currentUserId;
            const senderName = isSent ? 'You' : message.senderName;
            appendMessage(message.content, isSent ? 'sent' : 'received', senderName);
        });

    </script>
</body>
</html>